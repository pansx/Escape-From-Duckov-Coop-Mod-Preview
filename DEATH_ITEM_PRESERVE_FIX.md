# 客户端死亡物品保留临时修复

## 问题描述

在联机模式下，客机死亡时再次进入地图，坟墓里的东西会消失并提示 `[loot] 请求被拒绝: no_inv`。这是由于坟墓系统涉及底层代码，难以快速修复。

## 临时解决方案

本修复通过以下方式解决问题：

1. **拦截客户端玩家死亡逻辑** - 阻止原始的 `OnDead` 方法执行物品清空
2. **保留物品** - 客户端玩家死亡时不会清空库存和装备
3. **维持死亡状态** - 保持死亡的视觉效果和游戏状态，但物品不丢失

## 实现细节

### 主要补丁类

- `PlayerDeathItemPreservePatch` - 拦截玩家死亡逻辑
- `PreventClientPlayerItemClearPatch` - 阻止库存清空

### 工作原理

1. **死亡拦截**: 在客户端玩家的 `OnDead` 方法执行前拦截
2. **视觉效果**: 执行死亡动画和视觉效果，但跳过物品掉落
3. **状态管理**: 设置死亡状态但保留所有物品
4. **观战模式**: 正常进入观战模式（如果启用）

### 影响范围

- **仅影响客户端模式** - 主机模式不受影响
- **仅影响本地玩家** - 不影响AI或其他玩家
- **保持网络同步** - 死亡状态仍会正确同步给主机

## 使用说明

1. 编译并安装模组
2. 以客户端模式连接主机
3. 死亡时物品会自动保留
4. 控制台会显示相关日志信息

## 日志信息

修复激活时会在控制台显示以下信息：

```
[COOP] 客户端玩家死亡 - 启用物品保留模式（临时修复）
[COOP] 客户端玩家死亡处理完成 - 物品已保留（临时修复）
[COOP] 阻止客户端玩家死亡时清空库存（临时修复）
```

## 多语言支持

修复支持以下语言：

- 中文 (zh-CN)
- 英文 (en-US)  
- 日文 (ja-JP)
- 韩文 (ko-KR)

## 注意事项

1. **临时性质** - 这是一个临时解决方案，直到坟墓系统得到根本修复
2. **客户端限制** - 仅在客户端模式下生效
3. **兼容性** - 与现有的联机功能完全兼容
4. **性能影响** - 对游戏性能影响极小

## 未来计划

当坟墓系统的底层问题得到修复后，这个临时补丁可以被移除或禁用。

## 技术细节

### 文件位置

- 主要补丁: `EscapeFromDuckovCoopMod/Patch/Character/PlayerDeathItemPreservePatch.cs`
- 本地化文件: `Localization/*.json`

### 依赖项

- HarmonyLib (用于方法拦截)
- 现有的联机模组基础设施

### 测试建议

1. 以客户端模式连接主机
2. 携带一些物品进入游戏
3. 故意死亡
4. 检查物品是否保留
5. 验证观战模式是否正常工作