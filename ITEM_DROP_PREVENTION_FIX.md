# ç‰©å“æ‰è½é˜²æŠ¤ä¿®å¤

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šå®¢æœºæ²¡é—®é¢˜ï¼Œä½†ä¸»æœºä¼šçœ‹åˆ°å®¢æœºçš„ä¸œè¥¿ä¸€ä¸ªä¸€ä¸ªçš„æ‰äº†ä¸€åœ°ã€‚

## æ ¹æœ¬åŸå› åˆ†æ
åœ¨ `UpdateGameTombstoneInventory` æ–¹æ³•ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ `inventory.RemoveAt(i, out _)` é€ä¸ªç§»é™¤å¢“ç¢‘ä¸­çš„ç‰©å“æ—¶ï¼Œæ¸¸æˆçš„ç‰©å“æ‰è½æœºåˆ¶è¢«è§¦å‘äº†ã€‚

æ¸¸æˆè®¤ä¸ºè¿™äº›ç‰©å“è¢«"ä¸¢å¼ƒ"äº†ï¼Œæ‰€ä»¥åœ¨åœ°é¢ä¸Šç”Ÿæˆäº†æ‰è½ç‰©å“ï¼Œå¯¼è‡´ä¸»æœºçœ‹åˆ°å®¢æœºçš„ç‰©å“æ•£è½ä¸€åœ°ã€‚

## è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ `COOPManager.LootNet._serverApplyingLoot` æ ‡å¿—æ¥é˜»æ­¢ç‰©å“æ‰è½å’Œå…¶ä»–å‰¯ä½œç”¨ã€‚

è¿™ä¸ªæ ‡å¿—åœ¨æ•´ä¸ªä»£ç åº“ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œç”¨äºåœ¨æœåŠ¡ç«¯å¤„ç†ç½‘ç»œè¯·æ±‚æ—¶æŠ‘åˆ¶å„ç§å‰¯ä½œç”¨ï¼ŒåŒ…æ‹¬ï¼š
- ç‰©å“æ‰è½
- äºŒæ¬¡å¹¿æ’­
- UIæ›´æ–°
- å…¶ä»–åå¤„ç†é€»è¾‘

## ä¿®æ”¹å†…å®¹

### TombstonePersistence.cs - `UpdateGameTombstoneInventory` æ–¹æ³•

åœ¨æ¸…ç©ºå’Œé‡å»ºåº“å­˜æ—¶æ·»åŠ ä¿æŠ¤æ ‡å¿—ï¼š

```csharp
// è®¾ç½®æ ‡å¿—é˜»æ­¢ç‰©å“æ‰è½å’Œå…¶ä»–å‰¯ä½œç”¨
COOPManager.LootNet._serverApplyingLoot = true;

try
{
    // æ¸…ç©ºå½“å‰åº“å­˜ - é€ä¸ªç§»é™¤æ‰€æœ‰ç‰©å“
    var itemCount = inventory.Content.Count;
    for (int i = itemCount - 1; i >= 0; i--)
    {
        var item = inventory.GetItemAt(i);
        if (item != null)
        {
            inventory.RemoveAt(i, out _);
        }
    }
    
    // æ ¹æ®JSONæ•°æ®é‡å»ºåº“å­˜
    foreach (var tombstoneItem in tombstoneData.items)
    {
        var item = ItemTool.BuildItemFromSnapshot(tombstoneItem.snapshot);
        if (item != null)
        {
            inventory.AddAt(item, tombstoneItem.position);
            rebuiltCount++;
        }
    }
}
finally
{
    // ç¡®ä¿æ ‡å¿—è¢«é‡ç½®
    COOPManager.LootNet._serverApplyingLoot = false;
}
```

## æ ‡å¿—ä½œç”¨æœºåˆ¶

### `_serverApplyingLoot` æ ‡å¿—çš„ä½œç”¨
è¿™ä¸ªæ ‡å¿—åœ¨å¤šä¸ªPatchä¸­è¢«æ£€æŸ¥ï¼Œç”¨äºé˜»æ­¢ï¼š

1. **ç‰©å“æ‰è½** (`InventoryPatch.cs`)
   ```csharp
   if (!__result || COOPManager.LootNet._serverApplyingLoot) return;
   ```

2. **äºŒæ¬¡å¹¿æ’­** (`SlotPatch.cs`)
   ```csharp
   if (!__result || COOPManager.LootNet._serverApplyingLoot) return;
   ```

3. **UIæ›´æ–°** (`ItemUtilitiesPatch.cs`)
   ```csharp
   if (!__result || COOPManager.LootNet._serverApplyingLoot) return;
   ```

### ä½¿ç”¨æ¨¡å¼
åœ¨æ•´ä¸ªä»£ç åº“ä¸­ï¼Œè¿™ä¸ªæ ‡å¿—çš„ä½¿ç”¨æ¨¡å¼æ˜¯ï¼š
```csharp
_serverApplyingLoot = true;
try
{
    // æ‰§è¡Œå¯èƒ½è§¦å‘å‰¯ä½œç”¨çš„æ“ä½œ
    inventory.RemoveAt(i, out _);
    inventory.AddAt(item, position);
}
finally
{
    _serverApplyingLoot = false;
}
```

## å…³é”®ç‰¹æ€§

### ğŸ›¡ï¸ å‰¯ä½œç”¨é˜²æŠ¤
- **ç‰©å“æ‰è½é˜²æŠ¤**ï¼šé˜»æ­¢ç§»é™¤ç‰©å“æ—¶è§¦å‘æ‰è½
- **å¹¿æ’­æŠ‘åˆ¶**ï¼šé˜²æ­¢é‡å¤çš„ç½‘ç»œå¹¿æ’­
- **UIæ›´æ–°æŠ‘åˆ¶**ï¼šé¿å…ä¸å¿…è¦çš„ç•Œé¢åˆ·æ–°

### ğŸ”’ å®‰å…¨ä¿è¯
- **try-finallyç»“æ„**ï¼šç¡®ä¿æ ‡å¿—æ€»æ˜¯è¢«æ­£ç¡®é‡ç½®
- **å¼‚å¸¸å®‰å…¨**ï¼šå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¸ä¼šå½±å“åç»­æ“ä½œ
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šä¿æŒç½‘ç»œåŒæ­¥çŠ¶æ€çš„ä¸€è‡´æ€§

### ğŸ“Š è¯¦ç»†æ—¥å¿—
ä¿æŒåŸæœ‰çš„è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼š
```
[TOMBSTONE] Found game tombstone inventory with 10 items
[TOMBSTONE] Rebuilt item in game inventory: TypeID=67, Name=Grenade(Clone), Position=0
[TOMBSTONE] Game tombstone inventory updated: 2 items rebuilt
[TOMBSTONE] Broadcasting updated tombstone state to all clients: lootUid=3
```

## é¢„æœŸæ•ˆæœ

### âœ… ç‰©å“ä¸å†æ‰è½
- ä¸»æœºä¸ä¼šçœ‹åˆ°å®¢æœºçš„ç‰©å“æ•£è½ä¸€åœ°
- å¢“ç¢‘æ›´æ–°è¿‡ç¨‹å®Œå…¨é™é»˜è¿›è¡Œ
- åªæœ‰æœ€ç»ˆç»“æœä¼šè¢«å¹¿æ’­ç»™å®¢æˆ·ç«¯

### âœ… ç½‘ç»œåŒæ­¥æ­£å¸¸
- å‡æ³•æ“ä½œæ­£ç¡®æ‰§è¡Œ
- å¢“ç¢‘çŠ¶æ€æ­£ç¡®åŒæ­¥
- æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°ä¸€è‡´çš„ç»“æœ

### âœ… æ€§èƒ½ä¼˜åŒ–
- é¿å…ä¸å¿…è¦çš„ç‰©å“æ‰è½è®¡ç®—
- å‡å°‘é‡å¤çš„ç½‘ç»œå¹¿æ’­
- æé«˜å¢“ç¢‘æ›´æ–°æ•ˆç‡

## ç¼–è¯‘çŠ¶æ€
âœ… **ç¼–è¯‘æˆåŠŸ** - ä¿®æ”¹å·²é€šè¿‡ç¼–è¯‘æµ‹è¯•

## æµ‹è¯•å»ºè®®
1. å®¢æœºæ­»äº¡ï¼Œè£…å¤‡å›¾è…¾å’Œå…¶ä»–ç‰©å“
2. ä¸»æœºè§‚å¯Ÿåœ°é¢ï¼Œç¡®è®¤æ²¡æœ‰ç‰©å“æ‰è½
3. æ£€æŸ¥å¢“ç¢‘å†…å®¹æ˜¯å¦æ­£ç¡®ï¼ˆåªåŒ…å«åº”è¯¥æ‰è½çš„ç‰©å“ï¼‰
4. éªŒè¯æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°ä¸€è‡´çš„å¢“ç¢‘çŠ¶æ€
5. ç¡®è®¤å‡æ³•æ“ä½œæ—¥å¿—æ­£å¸¸

## ç›¸å…³ä»£ç å‚è€ƒ
è¿™ä¸ªä¿®å¤å‚è€ƒäº†ä»£ç åº“ä¸­å…¶ä»–åœ°æ–¹çš„ç±»ä¼¼å®ç°ï¼š
- `LootNet.cs` - ç½‘ç»œè¯·æ±‚å¤„ç†ä¸­çš„æ ‡å¿—ä½¿ç”¨
- `ItemTool.cs` - ç‰©å“æ‹†åˆ†æ“ä½œä¸­çš„æ ‡å¿—ä½¿ç”¨
- å„ç§ `Patch.cs` - æ ‡å¿—æ£€æŸ¥å’Œå‰¯ä½œç”¨æŠ‘åˆ¶

## æ€»ç»“
è¿™ä¸ªä¿®å¤è§£å†³äº†å¢“ç¢‘åŒæ­¥è¿‡ç¨‹ä¸­çš„ç‰©å“æ‰è½é—®é¢˜ï¼Œç¡®ä¿äº†ï¼š
- å¢“ç¢‘æ›´æ–°è¿‡ç¨‹çš„é™é»˜æ‰§è¡Œ
- ç½‘ç»œåŒæ­¥çš„æ­£ç¡®æ€§
- æ¸¸æˆä½“éªŒçš„æµç•…æ€§
- ç³»ç»Ÿæ€§èƒ½çš„ä¼˜åŒ–