---
inclusion: always
---

# 编码规范和最佳实践

## C# 编码规范

### 命名约定
- **类名**: PascalCase (如 `COOPManager`, `NetService`)
- **方法名**: PascalCase (如 `InitManager()`, `SendPlayerStatus()`)
- **字段和属性**: camelCase (如 `isConnecting`, `playerStatuses`)
- **常量**: PascalCase (如 `ModVersion`, `Name`)
- **私有字段**: 使用下划线前缀 (如 `_dedupeShotFrame`)

### 代码组织
- 使用 `global using` 统一管理常用命名空间
- 按功能模块组织代码文件
- 每个类都应有明确的职责
- 使用 `#region` 组织大型类的代码块

### 异步编程
- 优先使用 `UniTask` 而不是 `Task`
- 异步方法命名以 `Async` 结尾
- 正确处理异步异常和取消令牌
- 避免在Unity主线程中使用 `GetAwaiter().GetResult()`

## 网络编程规范

### 数据包设计
- 使用枚举定义操作码 (`Op` 类)
- 数据包结构要紧凑，避免冗余数据
- 重要数据使用 `ReliableOrdered` 传输
- 频繁更新的数据使用 `Unreliable` 传输

### 错误处理
- 网络操作必须包含异常处理
- 记录详细的错误日志用于调试
- 优雅处理连接断开和重连
- 验证接收到的数据有效性

### 内存管理
- 及时释放网络对象和GameObject
- 使用对象池管理频繁创建的对象
- 避免在网络回调中分配大量内存
- 定期清理无效的网络引用

## Harmony补丁规范

### 补丁命名
- 补丁类名格式: `[TargetClass]_[Method]_Patch`
- 使用描述性的补丁方法名
- 为复杂补丁添加详细注释

### 补丁安全性
- 始终检查目标对象是否为null
- 使用try-catch包装可能失败的操作
- 避免在补丁中抛出未处理的异常
- 测试补丁在各种游戏状态下的行为

### 性能考虑
- 避免在高频调用的方法中添加重型补丁
- 使用条件检查减少不必要的处理
- 缓存反射调用的结果
- 监控补丁对游戏性能的影响

## 调试和日志

### 日志规范
- 使用统一的日志前缀 `[COOP]`
- 区分不同级别的日志 (Debug, Info, Warning, Error)
- 包含足够的上下文信息
- 避免在发布版本中输出过多调试信息

### 调试技巧
- 使用条件编译指令控制调试代码
- 为网络同步添加可视化调试工具
- 记录关键状态变化的时间戳
- 提供开发者控制台命令

## 多语言支持

### 本地化规范
- 所有用户可见的文本都要本地化
- 使用有意义的本地化键名
- 为翻译者提供上下文说明
- 测试不同语言下的UI布局

### 文本处理
- 避免硬编码文本字符串
- 使用参数化的本地化字符串
- 考虑不同语言的文本长度差异
- 支持从右到左的语言 (如果需要)

## 代码翻译规范

### 注释翻译
- 将英文注释翻译为中文，保持技术准确性
- 保留原有的XML文档注释格式
- 为复杂逻辑添加中文解释性注释

### 变量和方法命名
- 变量名和方法名保持英文（符合C#命名规范）
- 在变量声明后添加中文注释说明用途
- 类名和命名空间保持英文不变

### 日志和调试信息
- Debug.Log等调试信息可以使用中文
- 错误消息和警告信息使用中文
- 保持日志的技术准确性和可读性