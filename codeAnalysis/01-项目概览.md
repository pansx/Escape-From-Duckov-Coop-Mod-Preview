# 逃离鸭科夫联机模组 - 项目概览

## 项目基本信息

- **项目名称**: Escape From Duckov Coop Mod Preview (逃离鸭科夫联机模组先遣版)
- **版本**: 1.5.0
- **目标框架**: .NET Standard 2.1
- **开发语言**: C#
- **许可证**: 基于AGPL-3.0的修改版本，禁止商业用途

## 核心技术栈

### 网络通信
- **LiteNetLib**: UDP网络库，提供高性能的网络通信
- **架构模式**: 主机-客户端模式 (Host-Client)
- **同步频率**: 0.015秒 (约67Hz，高频同步)
- **传输方式**: 
  - 关键数据使用 `ReliableOrdered` (可靠有序)
  - 频繁数据使用 `Unreliable` (不可靠但快速)

### 代码注入
- **HarmonyLib 2.x**: 运行时代码修改框架
- **注入方式**: 前缀/后缀补丁，避免完全替换原方法
- **目标**: 游戏核心逻辑的多人同步改造

### 异步编程
- **UniTask**: Unity优化的异步编程库
- **全局引用**: 通过 GlobalUsings.cs 统一管理常用命名空间

## 项目结构

### 核心目录结构
```
EscapeFromDuckovCoopMod/
├── Main/                    # 核心管理器和服务
│   ├── AI/                  # AI同步系统
│   ├── ClientService/       # 客户端服务
│   ├── HostService/         # 主机服务
│   ├── Health/              # 血量和伤害系统
│   ├── Item/                # 物品同步系统
│   ├── Weapon/              # 武器同步系统
│   ├── SceneService/        # 场景和环境同步
│   ├── LocalPlayer/         # 本地玩家管理
│   ├── UI/                  # 用户界面
│   ├── Localization/        # 多语言支持
│   └── WeatherAndTime/      # 天气和时间同步
├── Net/                     # 网络相关组件
├── Patch/                   # Harmony补丁
├── SyncData/                # 同步数据管理
└── NetTag/                  # 网络对象标记
```

### 关键文件说明

#### 核心管理器
- **COOPManager.cs**: 总管理器，负责初始化所有子系统
- **NetService.cs**: 网络服务核心，处理连接和消息分发
- **Op.cs**: 网络操作码定义，包含所有网络消息类型

#### 配置文件
- **GlobalUsings.cs**: 全局using声明
- **BuildInfo.cs**: 版本和构建信息
- **Directory.Build.props**: MSBuild属性配置

## 核心功能模块

### 1. 网络同步系统
- 玩家位置、动作、装备同步
- AI敌人状态同步
- 物品和战利品同步
- 环境对象同步（门、可破坏物等）

### 2. 场景管理
- 场景切换投票系统
- 自动重连机制
- 场景状态同步

### 3. 战斗系统
- 武器射击同步
- 近战攻击同步
- 手雷投掷同步
- 伤害计算和血量同步

### 4. 物品系统
- 装备穿戴同步
- 物品拾取和丢弃
- 战利品箱管理
- 物品附件系统

## 开发环境要求

### 必需软件
- Visual Studio 2019+
- .NET Framework 4.8
- Unity游戏本体（用于引用游戏DLL）

### 环境变量
- `DUCKOV_GAME_DIRECTORY`: 游戏根目录路径
- 系统自动计算: `DUCKOV_GAME_MANAGED` = `$(DUCKOV_GAME_DIRECTORY)\Duckov_Data\Managed`

### 依赖库
- **Shared目录**:
  - `0Harmony.dll`: Harmony框架
  - `LiteNetLib.dll`: 网络通信库
- **游戏DLL**: 从游戏Managed目录引用的所有Unity和游戏程序集

## 多语言支持

### 支持语言
- 中文 (zh-CN) - 主要语言
- 英文 (en-US)
- 日文 (ja-JP)
- 韩文 (ko-KR)
- 葡萄牙语 (pt-BR)

### 本地化文件
位于 `Localization/` 目录下的JSON文件，通过 `CoopLocalization` 类管理。

## 编译和部署

### 编译脚本
- **Build.bat**: 完整编译，包含环境检查
- **QuickBuild.bat**: 快速编译，适合频繁测试
- **BuildDebug.bat**: 调试版本编译

### 自动部署
编译成功后自动复制到游戏模组目录：
`$(DUCKOV_MODS_DIRECTORY)\EscapeFromDuckovCoopMod\`

## 架构特点

### 主机-客户端模式
- **主机**: 拥有游戏状态权威性，运行AI逻辑
- **客户端**: 接收状态更新，发送本地输入
- **同步原则**: 主机决定，客户端表现

### 高频同步
- 67Hz的同步频率确保流畅的多人体验
- 智能的数据压缩和增量更新
- 基于重要性的传输方式选择

### 容错设计
- 自动重连机制
- 场景切换后的状态恢复
- 网络异常的优雅处理
- 数据完整性验证

这个项目是一个功能完整、架构清晰的多人游戏模组，通过精心设计的网络同步系统为单人游戏添加了稳定的多人合作功能。